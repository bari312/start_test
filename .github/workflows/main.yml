name: LocalStack Service Test
on: [push, pull_request]

jobs:
  test_localstack_setup:
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        # ğŸš¨ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆGitHub Actionsã«ä»»ã›ãªã„ï¼‰
        env:
          DEFAULT_REGION: us-east-1
          DOCKER_HOST: unix:///var/run/docker.sock
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # ... (TA-Lib ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ãªã©) ...
      
      # ğŸš¨ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ãƒ†ãƒƒãƒ—å†…ã§æ‰‹å‹•å®Ÿè¡Œã™ã‚‹ï¼ˆä»¥å‰ã®å®‰å®šã—ãŸæ–¹æ³•ï¼‰
      - name: Wait for LocalStack to be ready (Manual Check)
        run: |
          echo "Waiting for LocalStack to be ready..."
          # ä»¥å‰ä½¿ã£ãŸ curl ã¨ grep ã®ãƒ«ãƒ¼ãƒ—ã‚’å¾©æ´»ã•ã›ã‚‹
          for i in {1..30}; do
            # å®‰å®šã—ãŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ (200 OKãŒè¿”ã‚‹ã¾ã§)
            if curl -s http://localhost:4566/ | grep 'LocalStack'; then
              echo "LocalStack is ready!"
              exit 0
            fi
            sleep 5
          done
          echo "LocalStack failed to start within the timeout (Manual Check)."
          exit 1
          
      - name: Verify LocalStack Service is Up
        run: |
          # æ¥ç¶šç¢ºèªç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒãƒ³ãƒ‰
          curl http://localhost:4566/

      # ... (TA-Lib ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ã“ã«æˆ»ã™) ...

      # 1. TA-Lib æœ¬ä½“ (Cè¨€èªãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å¤‰æ›´ãªã—)
      - name: Install TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
      
    
          
      - name: Just print a message
        run: echo "TA-Lib and LocalStack environment ready for use."
