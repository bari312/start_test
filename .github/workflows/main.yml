name: CI/CD with Trading Environment
on: [push, pull_request]

jobs:
  build-and-test:  # ğŸ‘ˆ jobs ã®ä¸‹ã« 2ã‚¹ãƒšãƒ¼ã‚¹
    runs-on: ubuntu-latest  # ğŸ‘ˆ build-and-test: ã®ä¸‹ã« 4ã‚¹ãƒšãƒ¼ã‚¹
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
# ... (ä»¥é™ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚‚é©åˆ‡ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’ç¶­æŒ) ...
    # 2. LocalStackã®ãŸã‚ã®Dockerç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    # LocalStackã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
    - name: Set up LocalStack (Docker)
      # docker-composeã¾ãŸã¯docker runã§LocalStackã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
      # ãƒãƒ¼ãƒˆ4566ãŒLocalStackã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAPIãƒãƒ¼ãƒˆ
      run: |
        docker pull localstack/localstack
        docker run -d \
          --name localstack-container \
          -p 4566:4566 \
          localstack/localstack
    
    # LocalStackãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ (éå¸¸ã«é‡è¦)
    - name: Wait for LocalStack to be ready
      # LocalStackã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒOKã‚’è¿”ã™ã¾ã§å¾…æ©Ÿ
      run: |
        echo "Waiting for LocalStack to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:4566/_localstack/health | grep '"status": "running"'; then
            echo "LocalStack is ready!"
            exit 0
          fi
          sleep 5
        done
        echo "LocalStack failed to start."
        exit 1

    # 3. Pythonç’°å¢ƒã¨ä¾å­˜é–¢ä¿‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: Set up Python and Cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      # TA-Libã®Pythonãƒ©ãƒƒãƒ‘ãƒ¼ã‚‚ã“ã“ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™
      run: pip install -r requirements.txt
      
    # 4. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
    # ãƒ†ã‚¹ãƒˆã¯LocalStackã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«é©åˆ‡ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    - name: Run tests with pytest
      # LocalStackã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      env:
        # LocalStackã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®š
        AWS_ENDPOINT_URL: http://localhost:4566
        # ãƒ€ãƒŸãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ï¼ˆLocalStackã§ã¯ã“ã‚Œã§ååˆ†ï¼‰
        AWS_ACCESS_KEY_ID: dummy
        AWS_SECRET_ACCESS_KEY: dummy
        AWS_REGION: us-east-1
      run: |
        # ã“ã“ã§pytestãŒå®Ÿè¡Œã•ã‚Œã€ãƒ†ã‚¹ãƒˆå†…ã§LocalStack (S3ãªã©)ãŒåˆ©ç”¨å¯èƒ½
        pytest
