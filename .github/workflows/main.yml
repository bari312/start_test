name: LocalStack Docker Setup Test
on: [push, pull_request]

jobs:
  test_localstack_setup: # ã‚¸ãƒ§ãƒ–åã‚’å¤‰æ›´
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. TA-Lib æœ¬ä½“ (Cè¨€èªãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å¤‰æ›´ãªã—)
      - name: Install TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
      
      # 2. LocalStackã®ãŸã‚ã®Dockerç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—)
      - name: Set up LocalStack (Docker)
        run: |
          docker pull localstack/localstack
          docker run -d \
            --name localstack-container \
            -p 4566:4566 \
            localstack/localstack

  # ğŸš¨ LocalStackãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—ã®ç›´å‰ã«è¿½åŠ  ğŸš¨
      - name: Debug LocalStack Container Logs
        # ã‚³ãƒ³ãƒ†ãƒŠå (localstack-container) ã®ãƒ­ã‚°ã‚’å‡ºåŠ›
        run: docker logs localstack-container
        # å¤±æ•—ã—ã¦ã‚‚ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã«å®Ÿè¡Œã‚’ç¶šã‘ã‚‹ã‚ˆã†ã«è¨­å®š
        if: always()

     # ä¿®æ­£å¾Œã® LocalStack å¾…æ©Ÿã‚¹ãƒ†ãƒƒãƒ—
      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          # 30å›ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é•·150ç§’ï¼‰
          # /health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯å®‰å®šã—ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€å˜ç´”ãª /
          for i in {1..30}; do
            if curl -s http://localhost:4566/ | grep 'LocalStack'; then
              echo "LocalStack is ready!"
              exit 0
            fi
            sleep 5
          done
          echo "LocalStack failed to start within the timeout."
          exit 1
          
      - name: Just print a message
        run: echo "TA-Lib and LocalStack environment ready for use."
