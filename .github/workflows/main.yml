name: LocalStack Service Test
on: [push, pull_request]

jobs:
  test_localstack_setup:
    runs-on: ubuntu-latest
    
    # ... (jobs: build-and-test: ã®ä¸‹ã® services: ã‚»ã‚¯ã‚·ãƒ§ãƒ³) ...

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        # ğŸš¨ ãƒ¡ãƒ¢ãƒªä½¿ç”¨ã‚’æ¸›ã‚‰ã™ãŸã‚ã€å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã«é™å®š (S3ã¨SNSã‚’ä¾‹ã¨ã™ã‚‹)
        env:
          SERVICES: s3,sns 
          # å¾…æ©Ÿæ™‚é–“ã‚’é•·ãã™ã‚‹è¨­å®šï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®å¾…æ©Ÿè¨­å®šï¼‰
          START_TIMEOUT: 120 
          # ãã®ä»–
          DOCKER_HOST: unix:///var/run/docker.sock
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # ... (TA-Lib ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã®ä¸­ç•¥) ...
      
      # ğŸš¨ æ–°ã—ã„ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒƒãƒ—: LocalStackã®ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
      - name: Force Print LocalStack Logs to File
        run: |
          # ã‚³ãƒ³ãƒ†ãƒŠIDã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åã¯localstackï¼‰
          CONTAINER_ID=$(docker ps -aqf "name=localstack")
          
          # ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          docker logs $CONTAINER_ID > localstack_logs.txt 2>&1
          
          echo "--- LocalStack Container Logs ---"
          cat localstack_logs.txt
          echo "---------------------------------"
          
          # è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„ã‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if grep -i "FATAL" localstack_logs.txt; then
            echo "::error::LocalStack FATAL error detected in logs. Check output above."
            exit 1
          fi
          
        if: always() # å¤±æ•—ã—ã¦ã‚‚å¿…ãšå®Ÿè¡Œ

      # ğŸš¨ Manual Checkã®ä»£ã‚ã‚Šã«ã€ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªå¾…æ©Ÿã‚³ãƒãƒ³ãƒ‰ã‚’è©¦ã™
      - name: Wait for LocalStack to be ready (Final Attempt)
        run: |
          echo "Checking LocalStack port 4566 status..."
          # nc (netcat) ã‚’ä½¿ã£ã¦ãƒãƒ¼ãƒˆãŒé–‹ãã¾ã§å¾…æ©Ÿã™ã‚‹ç¢ºå®Ÿãªæ–¹æ³•
          sudo apt-get install -y netcat
          nc -zv localhost 4566 -w 1 -c 30 # 1ç§’é–“éš”ã§30å›ã¾ã§ãƒãƒ¼ãƒˆæ¥ç¶šã‚’è©¦ã¿ã‚‹
          
      - name: Verify LocalStack Service is Up
        run: curl http://localhost:4566/

      # ... (pytest å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã¸ç¶šã) ...
      # 1. TA-Lib æœ¬ä½“ (Cè¨€èªãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å¤‰æ›´ãªã—)
      - name: Install TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
      
    
          
      - name: Just print a message
        run: echo "TA-Lib and LocalStack environment ready for use."
