name: CI/CD with Trading Environment
on: [push, pull_request]

jobs:
  build-and-test:  
    runs-on: ubuntu-latest  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install TA-Lib from source
        run: |
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
      - name: Set up LocalStack (Docker)
        run: |
          docker pull localstack/localstack
          docker run -d \
            --name localstack-container \
            -p 4566:4566 \
            localstack/localstack

      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:4566/_localstack/health | grep '"status": "running"'; then
              echo "LocalStack is ready!"
              exit 0
            fi
            sleep 5
          done
          echo "LocalStack failed to start."
          exit 1

      - name: Set up Python and Cache
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run tests with pytest
        env:
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: dummy
          AWS_SECRET_ACCESS_KEY: dummy
          AWS_REGION: us-east-1
      run: |
        # ここでpytestが実行され、テスト内でLocalStack (S3など)が利用可能
        pytest
