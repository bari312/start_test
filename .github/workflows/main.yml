name: LocalStack Service Test
on: [push, pull_request]

jobs:
  test_localstack_setup:
    runs-on: ubuntu-latest
    
    # ... (jobs: build-and-test: ã®ä¸‹ã® services: ã‚»ã‚¯ã‚·ãƒ§ãƒ³) ...

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        # ğŸš¨ ãƒ¡ãƒ¢ãƒªä½¿ç”¨ã‚’æ¸›ã‚‰ã™ãŸã‚ã€å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ã«é™å®š (S3ã¨SNSã‚’ä¾‹ã¨ã™ã‚‹)
        env:
          SERVICES: s3,dynamodb,lambda,sqs,ec2
          # å¾…æ©Ÿæ™‚é–“ã‚’é•·ãã™ã‚‹è¨­å®šï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®å¾…æ©Ÿè¨­å®šï¼‰
          START_TIMEOUT: 120 
          # ãã®ä»–
          DOCKER_HOST: unix:///var/run/docker.sock
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # ... (TA-Lib ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã®ä¸­ç•¥) ...
      
      # ğŸš¨ æ–°ã—ã„ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒƒãƒ—: LocalStackã®ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
      - name: Force Print LocalStack Logs to File
        run: |
          # ã‚³ãƒ³ãƒ†ãƒŠIDã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åã¯localstackï¼‰
          CONTAINER_ID=$(docker ps -aqf "name=localstack")
          
          # ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          docker logs $CONTAINER_ID > localstack_logs.txt 2>&1
          
          echo "--- LocalStack Container Logs ---"
          cat localstack_logs.txt
          echo "---------------------------------"
          
          # è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„ã‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if grep -i "FATAL" localstack_logs.txt; then
            echo "::error::LocalStack FATAL error detected in logs. Check output above."
            exit 1
          fi
          
        if: always() # å¤±æ•—ã—ã¦ã‚‚å¿…ãšå®Ÿè¡Œ

     

      # ... (pytest å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—ã¸ç¶šã) ...
      # 1. TA-Lib æœ¬ä½“ (Cè¨€èªãƒ©ã‚¤ãƒ–ãƒ©ãƒª) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å¤‰æ›´ãªã—)
      - name: Install TA-Lib from source
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzvf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
      
    
          
      - name: Just print a message
        run: echo "TA-Lib and LocalStack environment ready for use."

# ... (Install TA-Lib from source ã®ç›´å¾Œã€ã¾ãŸã¯é©åˆ‡ãªå ´æ‰€) ...
      
      # ğŸš¨ 1. Python ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # ä½¿ç”¨ã™ã‚‹Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³

      # ğŸš¨ 2. ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ (é«˜é€ŸåŒ–ã®ãŸã‚)
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ğŸš¨ 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      # ğŸš¨ 4. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      - name: Run tests with pytest
        # LocalStackã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        env:
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: dummy
          AWS_SECRET_ACCESS_KEY: dummy
          AWS_REGION: us-east-1
          # pytest å®Ÿè¡Œ
        run: pytest
